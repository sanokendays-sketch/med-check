<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>服薬チェック（朝・昼・晩）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ✅ PWA設定 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex justify-center p-6">
  <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 border border-slate-200">
    <header class="flex items-center mb-4">
      <div class="text-3xl mr-2">💊📅</div>
      <h1 class="text-xl font-bold flex-grow">服薬チェック（朝・昼・晩）</h1>
      <div id="now" class="text-sm text-slate-500"></div>
    </header>

    <!-- カレンダー -->
    <section class="bg-white border border-slate-200 rounded-xl p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <button id="prevBtn" class="px-3 py-1 bg-slate-100 hover:bg-blue-100 text-slate-600 rounded-md">« 前月</button>
        <h2 id="monthTitle" class="text-lg font-semibold"></h2>
        <button id="nextBtn" class="px-3 py-1 bg-slate-100 hover:bg-blue-100 text-slate-600 rounded-md">来月 »</button>
      </div>

      <div id="weekdayRow" class="grid grid-cols-7 gap-1 text-center text-xs text-slate-500 mb-1"></div>
      <div id="calendar" class="grid grid-cols-7 gap-2"></div>

      <div class="flex gap-3 text-xs text-slate-500 mt-3">
        <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>未服薬</div>
        <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>服薬済</div>
      </div>
    </section>

    <!-- 詳細 -->
    <section class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="flex items-baseline gap-2 mb-4">
        <div id="detailDate" class="text-lg font-bold">YYYY年MM月DD日</div>
        <div id="detailWday" class="text-slate-500">（曜日）</div>
      </div>

      <div class="space-y-3">
        <div class="flex items-center border border-slate-200 rounded-lg p-3 hover:bg-blue-50 transition">
          <input type="checkbox" id="chk-morning" class="w-5 h-5 text-blue-600 mr-3" />
          <label for="chk-morning" class="font-medium w-12">朝</label>
          <div id="time-morning" class="text-sm text-slate-500 ml-auto">—</div>
        </div>
        <div class="flex items-center border border-slate-200 rounded-lg p-3 hover:bg-blue-50 transition">
          <input type="checkbox" id="chk-noon" class="w-5 h-5 text-blue-600 mr-3" />
          <label for="chk-noon" class="font-medium w-12">昼</label>
          <div id="time-noon" class="text-sm text-slate-500 ml-auto">—</div>
        </div>
        <div class="flex items-center border border-slate-200 rounded-lg p-3 hover:bg-blue-50 transition">
          <input type="checkbox" id="chk-evening" class="w-5 h-5 text-blue-600 mr-3" />
          <label for="chk-evening" class="font-medium w-12">晩</label>
          <div id="time-evening" class="text-sm text-slate-500 ml-auto">—</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ==== PWA Service Worker 登録 ====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('✅ Service Worker registered'))
        .catch(err => console.error('SW registration failed:', err));
    }

    // ==== アプリ本体 ====
    const $ = (s)=>document.querySelector(s);
    const calEl = $('#calendar');
    const monthTitle = $('#monthTitle');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const detailDateEl = $('#detailDate');
    const detailWdayEl = $('#detailWday');
    const nowEl = $('#now');

    const chkMorning = $('#chk-morning');
    const chkNoon = $('#chk-noon');
    const chkEvening = $('#chk-evening');
    const timeMorning = $('#time-morning');
    const timeNoon = $('#time-noon');
    const timeEvening = $('#time-evening');

    const STORAGE_KEY = 'medlog.v1';
    const WD = ['日','月','火','水','木','金','土'];

    $('#weekdayRow').innerHTML = WD.map(w=>`<div>${w}</div>`).join('');

    function ymd(dt){ return dt.toISOString().slice(0,10); }
    function makeKey(date){ return date.toISOString().slice(0,10); }
    function fmtDateJP(date){ return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`; }
    function fmtTimeJP(date){ return new Intl.DateTimeFormat('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(date); }

    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); } catch{ return {}; } }
    function save(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

    let viewMonth = new Date();
    viewMonth.setDate(1);
    let selectedDate = new Date();
    selectedDate.setHours(0,0,0,0);

    function setDose(key, part, checked){
      const db = load();
      const r = db[key] || {morning:null,noon:null,evening:null};
      if(checked){ r[part] = Date.now(); } else { r[part] = null; }
      if(!r.morning && !r.noon && !r.evening){ delete db[key]; } else { db[key] = r; }
      save(db);
    }

    function getTimeStr(ts){ return ts ? fmtTimeJP(new Date(ts)) : '—'; }

    function renderCalendar(){
      monthTitle.textContent = `${viewMonth.getFullYear()}年${viewMonth.getMonth()+1}月`;
      const first = new Date(viewMonth);
      const startW = first.getDay();
      const next = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 1);
      const daysInMonth = Math.round((next - first)/86400000);
      calEl.innerHTML = '';
      for(let i=0;i<startW;i++){ calEl.appendChild(document.createElement('div')); }
      const db = load();
      for(let d=1; d<=daysInMonth; d++){
        const cellDate = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), d);
        const key = makeKey(cellDate);
        const rec = db[key] || {};
        const taken = rec.morning || rec.noon || rec.evening;
        const day = document.createElement('button');
        day.className = `border border-slate-200 rounded-lg p-2 min-h-[70px] flex flex-col items-start transition ${ymd(cellDate)===ymd(selectedDate)?'ring-2 ring-blue-500':''} ${taken?'bg-blue-50':'bg-white hover:bg-slate-100'}`;
        day.innerHTML = `<div class='font-semibold text-sm ${taken?'text-blue-600':'text-slate-700'}'>${d}</div>
          <div class='flex gap-1 mt-1'>
            <span class='text-[11px] ${rec.morning?'text-blue-600 font-bold':'text-slate-400'}'>朝</span>
            <span class='text-[11px] ${rec.noon?'text-blue-600 font-bold':'text-slate-400'}'>昼</span>
            <span class='text-[11px] ${rec.evening?'text-blue-600 font-bold':'text-slate-400'}'>晩</span>
          </div>`;
        day.addEventListener('click',()=>{selectedDate=cellDate;renderCalendar();renderDetail();});
        calEl.appendChild(day);
      }
    }

    function renderDetail(){
      const key = makeKey(selectedDate);
      const db = load();
      const rec = db[key] || {morning:null,noon:null,evening:null};
      detailDateEl.textContent = fmtDateJP(selectedDate);
      detailWdayEl.textContent = `（${WD[selectedDate.getDay()]}）`;
      chkMorning.checked=!!rec.morning;timeMorning.textContent=getTimeStr(rec.morning);
      chkNoon.checked=!!rec.noon;timeNoon.textContent=getTimeStr(rec.noon);
      chkEvening.checked=!!rec.evening;timeEvening.textContent=getTimeStr(rec.evening);
      [timeMorning,timeNoon,timeEvening].forEach(el=>el.classList.remove('text-blue-600'));
      if(rec.morning) timeMorning.classList.add('text-blue-600');
      if(rec.noon) timeNoon.classList.add('text-blue-600');
      if(rec.evening) timeEvening.classList.add('text-blue-600');
    }

    function bindCheck(chkEl,part,timeEl){
      chkEl.addEventListener('change',()=>{
        const key=makeKey(selectedDate);
        setDose(key,part,chkEl.checked);
        const db=load();
        const rec=db[key]||{morning:null,noon:null,evening:null};
        timeEl.textContent=getTimeStr(rec[part]);
        renderCalendar();
        renderDetail();
      });
    }

    bindCheck(chkMorning,'morning',timeMorning);
    bindCheck(chkNoon,'noon',timeNoon);
    bindCheck(chkEvening,'evening',timeEvening);

    prevBtn.addEventListener('click',()=>{viewMonth.setMonth(viewMonth.getMonth()-1);renderCalendar();});
    nextBtn.addEventListener('click',()=>{viewMonth.setMonth(viewMonth.getMonth()+1);renderCalendar();});

    function tick(){ nowEl.textContent=new Intl.DateTimeFormat('ja-JP',{dateStyle:'full',timeStyle:'medium'}).format(new Date()); requestAnimationFrame(()=>setTimeout(tick,1000)); }

    renderCalendar();
    renderDetail();
    tick();
  </script>
</body>
</html>
